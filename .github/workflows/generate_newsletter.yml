name: GÃ©nÃ©ration et DÃ©ploiement de Newsletter

on:
  workflow_dispatch:     # Permet le dÃ©clenchement manuel
  schedule:
    - cron: '45 09 * * 5'  # Tous les vendredis Ã  09h45

permissions:
  contents: write
  pages: write
  id-token: write

jobs:

  generate-and-deploy-newsletter:
    runs-on: ubuntu-latest
    
    steps:
    - name: Configure Git
      run: |
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

    - name: Clone portfolio-newsletter
      run: |
        git clone https://${{ secrets.DEPLOY_TOKEN }}@github.com/SiaSia-dev/portfolio-newsletter.git
        cd portfolio-newsletter
        git checkout gh-pages
    
    - name: Clone PORTFOLIO
      run: |
        git clone https://${{ secrets.DEPLOY_TOKEN }}@github.com/SiaSia-dev/PORTFOLIO.git
    
    - name: Clone portfolio-automation
      run: |
        git clone https://${{ secrets.DEPLOY_TOKEN }}@github.com/SiaSia-dev/portfolio-automation.git
    
    - name: Configuration de Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install PyYAML markdown beautifulsoup4 requests html2text
    
    # Ajout: PrÃ©paration des rÃ©pertoires de suivi
    - name: PrÃ©paration des rÃ©pertoires de suivi
      run: |
        mkdir -p ${{ github.workspace }}/tracking
        # Copier les fichiers de suivi existants s'ils existent
        if [ -f "${{ github.workspace }}/portfolio-automation/scripts/processed_files.txt" ]; then
          cp ${{ github.workspace }}/portfolio-automation/scripts/processed_files.txt ${{ github.workspace }}/tracking/
        fi
        if [ -f "${{ github.workspace }}/portfolio-automation/scripts/last_scan_files.txt" ]; then
          cp ${{ github.workspace }}/portfolio-automation/scripts/last_scan_files.txt ${{ github.workspace }}/tracking/
        fi
    
    - name: GÃ©nÃ©rer la newsletter et dÃ©ployer
      run: |
        # GÃ©nÃ©rer la newsletter
        cd portfolio-automation
        python scripts/newsletter_generator.py
        
        # Configurer Git dans le rÃ©pertoire portfolio-newsletter
        cd ../portfolio-newsletter
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Committer les changements
        git add .
        git commit -m "Mise Ã  jour de la newsletter" || echo "Pas de changements Ã  committer"
        git push origin gh-pages || echo "Pas de changements Ã  pousser"
        
        # Sauvegarde des fichiers de suivi
        cd ../portfolio-automation
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add scripts/processed_files.txt scripts/last_scan_files.txt || true
        git commit -m "Mise Ã  jour des fichiers de suivi" || echo "Pas de changements Ã  committer"
        git push origin main || echo "Pas de changements Ã  pousser"
      env:
        PORTFOLIO_DIR: ${{ github.workspace }}/PORTFOLIO
        OUTPUT_DIR: ${{ github.workspace }}/portfolio-newsletter
        TRACKING_DIR: ${{ github.workspace }}/tracking
        CREATE_INDEX: true
        CREATE_LATEST: true
        CREATE_ARCHIVES: true

    - name: Commit et pousse les images mises Ã  jour
      run: |
        set +e  # DÃ©sactive l'arrÃªt du script en cas d'erreur
        cd portfolio-newsletter
        
        # Configure Git localement pour ce dÃ©pÃ´t
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # VÃ©rifie s'il y a des changements Ã  committer
        if git status --porcelain | grep -q "img/"; then
          git add img/
          git commit -m "Mise Ã  jour des images de la newsletter"
          git push origin gh-pages
          echo "Images mises Ã  jour et poussÃ©es avec succÃ¨s"
        else
          echo "Aucune modification d'images Ã  pousser"
        fi
        set -e  # RÃ©active l'arrÃªt du script en cas d'erreur
    
    - name: Sauvegarde des fichiers de suivi
      run: |
        if [ -f "${{ github.workspace }}/tracking/processed_files.txt" ]; then
          cp ${{ github.workspace }}/tracking/processed_files.txt ${{ github.workspace }}/portfolio-automation/scripts/
        fi
        if [ -f "${{ github.workspace }}/tracking/last_scan_files.txt" ]; then
          cp ${{ github.workspace }}/tracking/last_scan_files.txt ${{ github.workspace }}/portfolio-automation/scripts/
        fi
        cd portfolio-automation
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        git add scripts/processed_files.txt scripts/last_scan_files.txt || true
        git commit -m "Mise Ã  jour des fichiers de suivi" || echo "Pas de changements dans les fichiers de suivi"
        git push origin main || echo "Pas de push nÃ©cessaire"

    - name: PrÃ©parer le dÃ©ploiement
      run: |
        cd portfolio-newsletter
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        git add .
        git commit -m "Mise Ã  jour newsletter" || echo "Pas de changements"
        git push origin gh-pages

    - name: Log newsletter files
      run: |
        echo "Liste des fichiers newsletter :"
        ls -l ${{ github.workspace }}/portfolio-newsletter/newsletter_*.html
        echo "Contenu du rÃ©pertoire :"
        ls -la ${{ github.workspace }}/portfolio-newsletter

    - name: VÃ©rification finale et rapport
      run: |
        echo "ðŸŽ‰ Newsletter gÃ©nÃ©rÃ©e avec succÃ¨s !"
        echo "URL de la newsletter : https://siasia-dev.github.io/portfolio-newsletter/latest.html"
        
        # VÃ©rifier que le fichier latest.html existe
        if [ -f "${{ github.workspace }}/portfolio-newsletter/latest.html" ]; then
          echo "âœ… Fichier latest.html prÃ©sent"
          ls -l "${{ github.workspace }}/portfolio-newsletter/latest.html"
        else
          echo "âŒ Fichier latest.html manquant"
          exit 1
        fi

        # VÃ©rifier le contenu du fichier
        FILE_SIZE=$(stat -c%s "${{ github.workspace }}/portfolio-newsletter/latest.html")
        if [ $FILE_SIZE -gt 1000 ]; then
          echo "âœ… Taille du fichier vÃ©rifiÃ©e : $FILE_SIZE octets"
        else
          echo "âŒ Fichier trop petit, problÃ¨me potentiel de gÃ©nÃ©ration"
          exit 1
        fi

    - name: Extraire le contenu de la newsletter pour la notification
      run: |
        # CrÃ©er un script temporaire pour extraire le contenu
        cat > extract_content.py << 'EOF'
        import requests
        from bs4 import BeautifulSoup
        # RÃ©cupÃ©rer la newsletter depuis l'URL
        url = "https://siasia-dev.github.io/portfolio-newsletter/latest.html"
        
        try:
            response = requests.get(url, timeout=10)
            response.raise_for_status()
            
            soup = BeautifulSoup(response.content, 'html.parser')
            
            # Extraire un rÃ©sumÃ© simple du contenu
            text_content = soup.get_text()
            
            # Identifier les thÃ¨mes principaux
            themes = []
            if "MCP" in text_content:
                themes.append("MCP et orchestration IA")
            if "architecture" in text_content.lower():
                themes.append("Architecture modulaire")
            if "mÃ©rÃ©ologie" in text_content.lower():
                themes.append("MÃ©rÃ©ologie et analyse")
            
            # CrÃ©er le rÃ©sumÃ©
            if themes:
                print(f"**ThÃ¨mes de cette Ã©dition :** {', '.join(themes)}")
            else:
                print("Articles variÃ©s sur l'innovation et la technologie")
                
        except Exception as e:
            print("Newsletter gÃ©nÃ©rÃ©e avec succÃ¨s - Contenu disponible en ligne")
        EOF
        
        # ExÃ©cuter le script et capturer la sortie
        NEWSLETTER_CONTENT=$(python extract_content.py)
        
        # CrÃ©er le template d'issue
        mkdir -p .github/ISSUE_TEMPLATE
        cat > .github/newsletter-notification.md << EOF
        ---
        title: "ðŸ”” Newsletter Portfolio gÃ©nÃ©rÃ©e - Ã€ vÃ©rifier"
        labels: notification
        assignees: SiaSia-dev
        ---
        # ðŸ“° Newsletter Portfolio - $(date +"%d/%m/%Y")
        La newsletter de cette semaine a Ã©tÃ© gÃ©nÃ©rÃ©e et est prÃªte pour votre validation.
        ## ðŸ”— Liens principaux
        - [Version complÃ¨te de la newsletter](https://siasia-dev.github.io/portfolio-newsletter/latest.html)
        - [Archives des newsletters](https://siasia-d ev.github.io/portfolio-newsletter/archives.html)
        ## ðŸ“‹ Contenu de la newsletter
        $NEWSLETTER_CONTENT
        ---
        ### âœ… Actions requises
        1. VÃ©rifier que la newsletter s'affiche correctement
        2. Confirmer que les liens entre les sections fonctionnent
        3. Valider les images des projets
        4. **Pour approuver** : Ajoutez le label \`approved\` Ã  cette issue
        ---
        GÃ©nÃ©rÃ©e automatiquement le $(date +"%d/%m/%Y Ã  %H:%M")
        EOF

    - name: CrÃ©er une issue de notification
      uses: JasonEtco/create-an-issue@v2
      env:
        GITHUB_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
      with:
        filename: .github/newsletter-notification.md
        update_existing: true
        search_existing: "Newsletter Portfolio gÃ©nÃ©rÃ©e - Ã€ vÃ©rifier"